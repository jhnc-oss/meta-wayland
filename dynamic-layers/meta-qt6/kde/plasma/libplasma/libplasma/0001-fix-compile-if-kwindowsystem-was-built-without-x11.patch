From d657e95f02a619224ab21c9082cd5432cfe97955 Mon Sep 17 00:00:00 2001
From: Markus Volk <f_l_k@t-online.de>
Date: Thu, 27 Nov 2025 20:41:51 +0100
Subject: [PATCH] fix compile if kwindowsystem was built without x11

Signed-off-by: Markus Volk <f_l_k@t-online.de>

Upstream-Status: Inappropriate [experimental]
---
 autotests/dialogstatetest.cpp                 | 47 -------------------
 .../core/windowthumbnail.cpp                  | 13 +----
 src/plasma/private/theme_p.cpp                | 21 +--------
 src/plasmaquick/appletpopup.cpp               |  9 +---
 src/plasmaquick/dialog.cpp                    | 33 +------------
 src/plasmaquick/plasmawindow.cpp              | 12 +----
 6 files changed, 9 insertions(+), 126 deletions(-)

diff --git a/src/declarativeimports/core/windowthumbnail.cpp b/src/declarativeimports/core/windowthumbnail.cpp
index 5e9f3f1ec..5caef5a8b 100644
--- a/src/declarativeimports/core/windowthumbnail.cpp
+++ b/src/declarativeimports/core/windowthumbnail.cpp
@@ -6,7 +6,6 @@
 #include "windowthumbnail.h"
 // KF5
 #include <KWindowSystem>
-#include <KX11Extras>
 // Qt
 #include <QGuiApplication>
 #include <QIcon>
@@ -282,10 +281,6 @@ void WindowThumbnail::setWinId(uint32_t winId)
     if (m_winId == winId) {
         return;
     }
-    if (KWindowSystem::isPlatformX11() && !KX11Extras::self()->hasWId(winId)) {
-        // invalid Id, don't updated
-        return;
-    }
     if (window() && winId == window()->winId()) {
         // don't redirect to yourself
         return;
@@ -395,12 +390,8 @@ bool WindowThumbnail::nativeEventFilter(const QByteArray &eventType, void *messa
 void WindowThumbnail::iconToTexture(WindowTextureProvider *textureProvider)
 {
     QIcon icon;
-    if (KWindowSystem::isPlatformX11() && KX11Extras::self()->hasWId(m_winId)) {
-        icon = KX11Extras::self()->icon(m_winId, boundingRect().width(), boundingRect().height());
-    } else {
-        // fallback to plasma icon
-        icon = QIcon::fromTheme(QStringLiteral("plasma"));
-    }
+    
+    icon = QIcon::fromTheme(QStringLiteral("plasma"));
     QImage image = icon.pixmap(boundingRect().size().toSize(), window()->devicePixelRatio()).toImage();
     textureProvider->setTexture(window()->createTextureFromImage(image, QQuickWindow::TextureCanUseAtlas));
 }
diff --git a/src/plasma/private/theme_p.cpp b/src/plasma/private/theme_p.cpp
index f4917a945..0d367ab24 100644
--- a/src/plasma/private/theme_p.cpp
+++ b/src/plasma/private/theme_p.cpp
@@ -17,8 +17,9 @@
 #include <KSharedConfig>
 #include <KWindowEffects>
 #include <KWindowSystem>
+#if HAVE_X11
 #include <KX11Extras>
-
+#endif
 namespace Plasma
 {
 const char ThemePrivate::defaultTheme[] = "default";
@@ -96,10 +97,6 @@ ThemePrivate::ThemePrivate(QObject *parent)
     , apiMinor(0)
     , apiRevision(0)
 {
-    if (KWindowSystem::isPlatformX11()) {
-        compositingActive = KX11Extras::self()->compositingActive();
-    }
-
     kSvgImageSet = std::unique_ptr<KSvg::ImageSet>(new KSvg::ImageSet);
     kSvgImageSet->setBasePath(QStringLiteral(PLASMA_RELATIVE_DATA_INSTALL_DIR "/desktoptheme/"));
 
@@ -121,9 +118,6 @@ ThemePrivate::ThemePrivate(QObject *parent)
 
     if (QPixmap::defaultDepth() > 8) {
         // watch for background contrast effect property changes as well
-        if (!s_blurEffectWatcher) {
-            s_blurEffectWatcher = new BlurEffectWatcher();
-        }
 
         QObject::connect(s_blurEffectWatcher, &BlurEffectWatcher::effectChanged, selectorsUpdateTimer, qOverload<>(&QTimer::start));
     }
@@ -139,9 +133,6 @@ ThemePrivate::ThemePrivate(QObject *parent)
         scheduleThemeChangeNotification();
     });
 
-    if (KWindowSystem::isPlatformX11()) {
-        connect(KX11Extras::self(), &KX11Extras::compositingChanged, selectorsUpdateTimer, qOverload<>(&QTimer::start));
-    }
     updateKSvgSelectors();
 }
 
@@ -197,15 +188,7 @@ QString ThemePrivate::findInTheme(const QString &image, const QString &theme)
 
 void ThemePrivate::updateKSvgSelectors()
 {
-#if HAVE_X11
-    if (KWindowSystem::isPlatformX11()) {
-        compositingActive = KX11Extras::compositingActive();
-    } else {
-        compositingActive = true;
-    }
-#else
     compositingActive = true;
-#endif
     backgroundContrastActive = s_blurEffectWatcher->isEffectActive();
 
     if (compositingActive) {
diff --git a/src/plasmaquick/appletpopup.cpp b/src/plasmaquick/appletpopup.cpp
index 5774c1888..87882e1aa 100644
--- a/src/plasmaquick/appletpopup.cpp
+++ b/src/plasmaquick/appletpopup.cpp
@@ -13,7 +13,6 @@
 
 #include <KConfigGroup>
 #include <KWindowSystem>
-#include <KX11Extras>
 
 #include "applet.h"
 #include "appletquickitem.h"
@@ -64,12 +63,8 @@ AppletPopup::AppletPopup()
     setAnimated(true);
     setFlags(flags() | Qt::Dialog);
 
-    if (KWindowSystem::isPlatformX11()) {
-        KX11Extras::setType(winId(), NET::AppletPopup);
-    } else {
-        PlasmaShellWaylandIntegration::get(this)->setRole(QtWayland::org_kde_plasma_surface::role::role_appletpopup);
-        PlasmaShellWaylandIntegration::get(this)->setTakesFocus(true);
-    }
+    PlasmaShellWaylandIntegration::get(this)->setRole(QtWayland::org_kde_plasma_surface::role::role_appletpopup);
+    PlasmaShellWaylandIntegration::get(this)->setTakesFocus(true);
 
     auto edgeForwarder = new EdgeEventForwarder(this);
     edgeForwarder->setMargins(padding());
diff --git a/src/plasmaquick/dialog.cpp b/src/plasmaquick/dialog.cpp
index 096c9c2c8..a916b1c75 100644
--- a/src/plasmaquick/dialog.cpp
+++ b/src/plasmaquick/dialog.cpp
@@ -24,9 +24,7 @@
 #include <QQuickItem>
 #include <QScreen>
 
-#include <KWindowInfo>
 #include <KWindowSystem>
-#include <KX11Extras>
 
 #include <KWindowEffects>
 #include <Plasma/Corona>
@@ -253,15 +251,8 @@ void DialogPrivate::updateTheme()
                                                  theme.backgroundSaturation(),
                                                  mask);
 
-        if (!KWindowSystem::isPlatformX11() || KX11Extras::compositingActive()) {
-            if (hasMask) {
-                hasMask = false;
-                q->setMask(QRegion());
-            }
-        } else {
-            hasMask = true;
-            q->setMask(dialogBackground->mask());
-        }
+        hasMask = true;
+        q->setMask(dialogBackground->mask());
         if (q->isVisible()) {
             DialogShadows::instance()->addWindow(q, dialogBackground->enabledBorders());
         }
@@ -747,9 +738,6 @@ void DialogPrivate::applyType()
     }
 #endif
 
-    if (!wmType && type != Dialog::Normal && KWindowSystem::isPlatformX11()) {
-        KX11Extras::setType(q->winId(), static_cast<NET::WindowType>(type));
-    }
     if (q->flags() & Qt::WindowStaysOnTopHint) {
         // If the AppletPopup type is not explicitly requested, then use the Dock type in this case
         // to avoid bug #454635.
@@ -812,14 +800,6 @@ void DialogPrivate::applyType()
         }
     }
 
-    if (KWindowSystem::isPlatformX11()) {
-        if (type == Dialog::Dock || type == Dialog::Notification || type == Dialog::OnScreenDisplay || type == Dialog::CriticalNotification) {
-            KX11Extras::setOnAllDesktops(q->winId(), true);
-        } else {
-            KX11Extras::setOnAllDesktops(q->winId(), false);
-        }
-    }
-
     PlasmaShellWaylandIntegration::get(q)->setTakesFocus(!q->flags().testFlag(Qt::WindowDoesNotAcceptFocus));
 }
 
@@ -1080,12 +1060,6 @@ QPoint Dialog::popupPosition(QQuickItem *item, const QSize &size)
     // if the item is in a window that ignores WM we want to position the popups outside
     bool outsideParentWindow = (item->window()->flags() & Qt::X11BypassWindowManagerHint) && item->window()->mask().isNull();
 
-    if (KWindowSystem::isPlatformX11()) {
-        // on X11 we also consider windows with the type Dock
-        const KWindowInfo winInfo(item->window()->winId(), NET::WMWindowType);
-        outsideParentWindow = outsideParentWindow || (winInfo.windowType(NET::AllTypesMask) == NET::Dock && item->window()->mask().isNull());
-    }
-
     QRect parentGeometryBounds;
     if (outsideParentWindow) {
         parentGeometryBounds = item->window()->geometry();
@@ -1358,9 +1332,6 @@ void Dialog::showEvent(QShowEvent *event)
         DialogShadows::instance()->addWindow(this, d->dialogBackground->enabledBorders());
     }
 
-    if (KWindowSystem::isPlatformX11()) {
-        KX11Extras::setState(winId(), NET::SkipTaskbar | NET::SkipPager | NET::SkipSwitcher);
-    }
     QQuickWindow::showEvent(event);
 }
 
diff --git a/src/plasmaquick/plasmawindow.cpp b/src/plasmaquick/plasmawindow.cpp
index 4aaf54821..a8c98cde6 100644
--- a/src/plasmaquick/plasmawindow.cpp
+++ b/src/plasmaquick/plasmawindow.cpp
@@ -13,7 +13,6 @@
 
 #include <KWindowEffects>
 #include <KWindowSystem>
-#include <KX11Extras>
 
 #include <Plasma/Theme>
 
@@ -141,11 +140,6 @@ Qt::Edges PlasmaWindow::borders()
 
 void PlasmaWindow::showEvent(QShowEvent *e)
 {
-    // EWMH states that the state is reset every hide
-    // Qt supports external factors setting state before the next show
-    if (KWindowSystem::isPlatformX11()) {
-        KX11Extras::setState(winId(), NET::SkipTaskbar | NET::SkipPager | NET::SkipSwitcher);
-    }
     QQuickWindow::showEvent(e);
 }
 
@@ -171,11 +165,7 @@ void PlasmaWindowPrivate::handleFrameChanged()
                                              theme.backgroundSaturation(),
                                              mask);
 
-    if (!KWindowSystem::isPlatformX11() || KX11Extras::compositingActive()) {
-        q->setMask(QRegion());
-    } else {
-        q->setMask(mask);
-    }
+    q->setMask(mask);
 }
 
 void PlasmaWindowPrivate::updateMainItemGeometry()
-- 
2.51.0

